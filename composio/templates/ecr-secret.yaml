{{- if and .Values.externalSecrets.ecr.enabled .Values.externalSecrets.ecr.token (not (lookup "v1" "Secret" (include "composio.namespace" .) "ecr-secret")) }}
apiVersion: v1
kind: Secret
metadata:
  name: ecr-secret
  namespace: {{ include "composio.namespace" . }}
  labels:
    {{- include "composio.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-10"
    "composio.dev/secret-type": "ecr"
    "composio.dev/auto-generated": "true"
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: {{ printf `{"auths":{"%s":{"username":"%s","password":"%s","auth":"%s"}}}` .Values.externalSecrets.ecr.server .Values.externalSecrets.ecr.username .Values.externalSecrets.ecr.token (printf "%s:%s" .Values.externalSecrets.ecr.username .Values.externalSecrets.ecr.token | b64enc) | b64enc }}
{{- else if and .Values.externalSecrets.ecr.enabled .Values.externalSecrets.ecr.token (lookup "v1" "Secret" (include "composio.namespace" .) "ecr-secret") }}
# ECR secret already exists - skipping creation to preserve existing values
{{- end }} 