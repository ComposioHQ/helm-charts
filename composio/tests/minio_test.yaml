suite: test minio deployment
templates:
  - minio.yaml
tests:
  - it: should create minio deployment
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-minio
      - equal:
          path: metadata.labels.app
          value: minio
      - equal:
          path: metadata.labels.release
          value: RELEASE-NAME

  - it: should have correct replica count
    set:
      minio.replicaCount: 2
    asserts:
      - equal:
          path: spec.replicas
          value: 2

  - it: should use correct image
    set:
      minio.image.repository: test-minio
      minio.image.tag: v2023
      minio.image.pullPolicy: IfNotPresent
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: test-minio:v2023
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: IfNotPresent

  - it: should have correct ports
    asserts:
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 9000
      - equal:
          path: spec.template.spec.containers[0].ports[1].containerPort
          value: 9001

  - it: should have correct authentication environment variables
    set:
      minio.auth.rootUser: testuser
      minio.auth.rootPassword: testpass123
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MINIO_ROOT_USER
            value: testuser
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MINIO_ROOT_PASSWORD
            value: testpass123

  - it: should have liveness probe
    set:
      minio.livenessProbe:
        httpGet:
          path: /minio/health/live
          port: 9000
        initialDelaySeconds: 120
        periodSeconds: 30
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /minio/health/live
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 120

  - it: should have readiness probe
    set:
      minio.readinessProbe:
        httpGet:
          path: /minio/health/ready
          port: 9000
        initialDelaySeconds: 30
        periodSeconds: 10
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /minio/health/ready
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.initialDelaySeconds
          value: 30

  - it: should have persistence volume mount when enabled
    set:
      minio.persistence.enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: minio-data
            mountPath: /data

  - it: should have resource configuration
    set:
      minio.resources:
        requests:
          memory: "2Gi"
          cpu: "1"
        limits:
          memory: "4Gi"
          cpu: "2"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: "2Gi"
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: "2"

---
suite: test minio service
templates:
  - minio.yaml
tests:
  - it: should create minio service
    documentIndex: 1
    asserts:
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: RELEASE-NAME-minio
      - equal:
          path: metadata.labels.app
          value: minio

  - it: should have correct service ports
    documentIndex: 1
    asserts:
      - equal:
          path: spec.ports[0].port
          value: 9000
      - equal:
          path: spec.ports[0].targetPort
          value: 9000
      - equal:
          path: spec.ports[1].port
          value: 9001
      - equal:
          path: spec.ports[1].targetPort
          value: 9001

---
suite: test minio pvc
templates:
  - minio.yaml
tests:
  - it: should create pvc when persistence enabled
    documentIndex: 2
    set:
      minio.persistence.enabled: true
      minio.persistence.size: 10Gi
      minio.persistence.accessMode: ReadWriteOnce
    asserts:
      - isKind:
          of: PersistentVolumeClaim
      - equal:
          path: metadata.name
          value: RELEASE-NAME-minio-data
      - equal:
          path: spec.accessModes[0]
          value: ReadWriteOnce
      - equal:
          path: spec.resources.requests.storage
          value: 10Gi 