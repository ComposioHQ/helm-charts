apiVersion: v1
kind: Secret
metadata:
  labels:
    troubleshoot.sh/kind: preflight
  name: "{{ .Release.Name }}-preflight-config"
stringData:
  preflight.yaml: |
    apiVersion: troubleshoot.sh/v1beta2
    kind: Preflight
    metadata:
      name: "{{ .Release.Name }}-secrets-preflight"
    spec:
      collectors:
        # --- Always: check chart-managed Secrets exist (useful on upgrades; warns/fails if missing) ---
        - secret:
            name: "{{ .Release.Name }}-apollo-admin-token"
            namespace: "{{ .Release.Namespace }}"
            key: "APOLLO_ADMIN_TOKEN"
            includeValue: false
        - secret:
            name: "{{ .Release.Name }}-composio-api-key"
            namespace: "{{ .Release.Namespace }}"
            key: "COMPOSIO_API_KEY"
            includeValue: false
        - secret:
            name: "{{ .Release.Name }}-encryption-key"
            namespace: "{{ .Release.Namespace }}"
            key: "ENCRYPTION_KEY"
            includeValue: false
        - secret:
            name: "{{ .Release.Name }}-jwt-secret"
            namespace: "{{ .Release.Namespace }}"
            key: "JWT_SECRET"
            includeValue: false
        - secret:
            name: "{{ .Release.Name }}-temporal-encryption-key"
            namespace: "{{ .Release.Namespace }}"
            key: "TEMPORAL_TRIGGER_ENCRYPTION_KEY"
            includeValue: false

        # --- Validate Composio API key by real HTTP request ---
        - runPod:
            collectorName: "validate-composio-api-key"
            namespace: "{{ .Release.Namespace }}"
            timeout: 60s
            podSpec:
              restartPolicy: Never
              containers:
                - name: check
                  image: curlimages/curl:latest
                  env:
                    - name: COMPOSIO_API_KEY
                      valueFrom:
                        secretKeyRef:
                          name: "{{ .Release.Name }}-composio-api-key"
                          key: "COMPOSIO_API_KEY"
                          optional: true
                  command: ["/bin/sh", "-c"]
                  args:
                    - |
                      if [ -z "${COMPOSIO_API_KEY:-}" ]; then
                        echo "RESULT=MISSING HTTP_CODE=000"
                        exit 0
                      fi

                      CODE="$(curl -sS -o /tmp/body -w '%{http_code}' \
                        -H "x-api-key: ${COMPOSIO_API_KEY}" \
                        https://backend.composio.dev/api/v3/auth/session/info || true)"

                      if [ -z "${CODE}" ]; then CODE="000"; fi
                      if [ "${CODE}" = "200" ]; then
                        echo "RESULT=OK HTTP_CODE=${CODE}"
                      elif [ "${CODE}" = "401" ] || [ "${CODE}" = "403" ]; then
                        echo "RESULT=INVALID HTTP_CODE=${CODE}"
                      else
                        echo "RESULT=ERROR HTTP_CODE=${CODE}"
                      fi

        {{- if .Values.openAI.enabled }}
        # --- Source OpenAI secret referenced by your values ---
        - secret:
            name: "{{ .Values.openAI.secretRef }}"
            namespace: "{{ .Release.Namespace }}"
            key: "{{ .Values.openAI.key }}"
            includeValue: false

        # --- Validate OpenAI key by real HTTP request ---
        - runPod:
            collectorName: "validate-openai-api-key"
            namespace: "{{ .Release.Namespace }}"
            timeout: 60s
            podSpec:
              restartPolicy: Never
              containers:
                - name: check
                  image: curlimages/curl:latest
                  env:
                    - name: OPENAI_API_KEY
                      valueFrom:
                        secretKeyRef:
                          name: "{{ .Values.openAI.secretRef }}"
                          key: "{{ .Values.openAI.key }}"
                          optional: true
                  command: ["/bin/sh", "-c"]
                  args:
                    - |
                      if [ -z "${OPENAI_API_KEY:-}" ]; then
                        echo "RESULT=MISSING HTTP_CODE=000"
                        exit 0
                      fi

                      CODE="$(curl -sS -o /tmp/body -w '%{http_code}' \
                        -H "Authorization: Bearer ${OPENAI_API_KEY}" \
                        https://api.openai.com/v1/models || true)"

                      if [ -z "${CODE}" ]; then CODE="000"; fi
                      if [ "${CODE}" = "200" ]; then
                        echo "RESULT=OK HTTP_CODE=${CODE}"
                      elif [ "${CODE}" = "401" ] || [ "${CODE}" = "403" ]; then
                        echo "RESULT=INVALID HTTP_CODE=${CODE}"
                      else
                        echo "RESULT=ERROR HTTP_CODE=${CODE}"
                      fi
        {{- end }}

        {{- if eq .Values.apollo.objectStorage.backend "s3" }}
        # --- Source S3 secrets referenced by your values ---
        - secret:
            name: "{{ .Values.apollo.objectStorage.accessKey.secretName }}"
            namespace: "{{ .Release.Namespace }}"
            key: "{{ .Values.apollo.objectStorage.accessKey.key }}"
            includeValue: false
        - secret:
            name: "{{ .Values.apollo.objectStorage.secretKey.secretName }}"
            namespace: "{{ .Release.Namespace }}"
            key: "{{ .Values.apollo.objectStorage.secretKey.key }}"
            includeValue: false
        {{- end }}

        {{- if eq .Values.apollo.objectStorage.backend "azure_blob_storage" }}
        - secret:
            name: "{{ .Values.apollo.objectStorage.azureConnectionString.secretName }}"
            namespace: "{{ .Release.Namespace }}"
            key: "{{ .Values.apollo.objectStorage.azureConnectionString.key }}"
            includeValue: false
        {{- end }}

        {{- if .Values.smtp.connectionString }}
        - secret:
            name: "{{ .Values.smtp.password.secretRef }}"
            namespace: "{{ .Release.Namespace }}"
            key: "{{ .Values.smtp.password.key }}"
            includeValue: false

        # Optional: basic TCP connectivity to SMTP host:port (does not validate auth)
        - runPod:
            collectorName: "check-smtp-tcp"
            namespace: "{{ .Release.Namespace }}"
            timeout: 60s
            podSpec:
              restartPolicy: Never
              containers:
                - name: check
                  image: alpine:3.19
                  command: ["/bin/sh", "-c"]
                  args:
                    - |
                      apk add --no-cache busybox-extras >/dev/null 2>&1 || true
                      if nc -vz -w 5 "{{ .Values.smtp.host }}" "{{ .Values.smtp.port }}"; then
                        echo "RESULT=OK"
                      else
                        echo "RESULT=ERROR"
                      fi
        {{- end }}

        # --- Source Postgres password secrets referenced by values (apollo + thermos) ---
        - secret:
            name: "{{ .Values.database.apollo.password.secretRef }}"
            namespace: "{{ .Release.Namespace }}"
            key: "{{ .Values.database.apollo.password.key }}"
            includeValue: false

        - secret:
            name: "{{ .Values.database.thermos.password.secretRef }}"
            namespace: "{{ .Release.Namespace }}"
            key: "{{ .Values.database.thermos.password.key }}"
            includeValue: false

        # --- Validate Postgres connectivity (apollo) ---
        - runPod:
            collectorName: "validate-postgres-apollo"
            namespace: "{{ .Release.Namespace }}"
            timeout: 60s
            podSpec:
              restartPolicy: Never
              containers:
                - name: check
                  image: postgres:16-alpine
                  env:
                    - name: PGHOST
                      value: "{{ .Values.database.apollo.host }}"
                    - name: PGPORT
                      value: "{{ .Values.database.apollo.port | quote }}"
                    - name: PGDATABASE
                      value: "{{ .Values.database.apollo.database }}"
                    - name: PGUSER
                      value: "{{ .Values.database.apollo.user }}"
                    - name: PGSSLMODE
                      value: "{{ .Values.database.apollo.sslmode }}"
                    - name: PGPASSWORD
                      valueFrom:
                        secretKeyRef:
                          name: "{{ .Values.database.apollo.password.secretRef }}"
                          key: "{{ .Values.database.apollo.password.key }}"
                          optional: true
                  command: ["/bin/sh", "-c"]
                  args:
                    - |
                      if [ -z "${PGPASSWORD:-}" ]; then
                        echo "RESULT=MISSING"
                        exit 0
                      fi
                      if psql -Atqc "select 1" >/dev/null 2>&1; then
                        echo "RESULT=OK"
                      else
                        echo "RESULT=ERROR"
                      fi

        # --- Validate Postgres connectivity (thermos) ---
        - runPod:
            collectorName: "validate-postgres-thermos"
            namespace: "{{ .Release.Namespace }}"
            timeout: 60s
            podSpec:
              restartPolicy: Never
              containers:
                - name: check
                  image: postgres:16-alpine
                  env:
                    - name: PGHOST
                      value: "{{ .Values.database.thermos.host }}"
                    - name: PGPORT
                      value: "{{ .Values.database.thermos.port | quote }}"
                    - name: PGDATABASE
                      value: "{{ .Values.database.thermos.database }}"
                    - name: PGUSER
                      value: "{{ .Values.database.thermos.user }}"
                    - name: PGSSLMODE
                      value: "{{ .Values.database.thermos.sslmode }}"
                    - name: PGPASSWORD
                      valueFrom:
                        secretKeyRef:
                          name: "{{ .Values.database.thermos.password.secretRef }}"
                          key: "{{ .Values.database.thermos.password.key }}"
                          optional: true
                  command: ["/bin/sh", "-c"]
                  args:
                    - |
                      if [ -z "${PGPASSWORD:-}" ]; then
                        echo "RESULT=MISSING"
                        exit 0
                      fi
                      if psql -Atqc "select 1" >/dev/null 2>&1; then
                        echo "RESULT=OK"
                      else
                        echo "RESULT=ERROR"
                      fi

        {{- if .Values.externalRedis }}
        # Password secret is optional in your chart; still check if provided
        - secret:
            name: "{{ .Values.redisConnection.password.secretRef }}"
            namespace: "{{ .Release.Namespace }}"
            key: "{{ .Values.redisConnection.password.key }}"
            includeValue: false

        - runPod:
            collectorName: "validate-redis"
            namespace: "{{ .Release.Namespace }}"
            timeout: 60s
            podSpec:
              restartPolicy: Never
              containers:
                - name: check
                  image: redis:7-alpine
                  env:
                    - name: REDIS_HOST
                      value: "{{ .Values.redisConnection.host }}"
                    - name: REDIS_PORT
                      value: "{{ .Values.redisConnection.port | quote }}"
                    - name: REDIS_PASSWORD
                      valueFrom:
                        secretKeyRef:
                          name: "{{ .Values.redisConnection.password.secretRef }}"
                          key: "{{ .Values.redisConnection.password.key }}"
                          optional: true
                  command: ["/bin/sh", "-c"]
                  args:
                    - |
                      if [ -n "${REDIS_PASSWORD:-}" ]; then
                        redis-cli -h "${REDIS_HOST}" -p "${REDIS_PORT}" -a "${REDIS_PASSWORD}" PING >/dev/null 2>&1
                      else
                        redis-cli -h "${REDIS_HOST}" -p "${REDIS_PORT}" PING >/dev/null 2>&1
                      fi

                      if [ "$?" = "0" ]; then
                        echo "RESULT=OK"
                      else
                        echo "RESULT=ERROR"
                      fi
        {{- end }}

      analyzers:
        # --- Chart-managed secrets ---
        - secret:
            checkName: "Apollo admin token secret present"
            secretName: "{{ .Release.Name }}-apollo-admin-token"
            namespace: "{{ .Release.Namespace }}"
            key: "APOLLO_ADMIN_TOKEN"
            outcomes:
              - fail:
                  message: "Missing {{ .Release.Name }}-apollo-admin-token or key APOLLO_ADMIN_TOKEN."
              - pass:
                  message: "Found {{ .Release.Name }}-apollo-admin-token (APOLLO_ADMIN_TOKEN)."

        - secret:
            checkName: "Composio API key secret present"
            secretName: "{{ .Release.Name }}-composio-api-key"
            namespace: "{{ .Release.Namespace }}"
            key: "COMPOSIO_API_KEY"
            outcomes:
              - fail:
                  message: "Missing {{ .Release.Name }}-composio-api-key or key COMPOSIO_API_KEY."
              - pass:
                  message: "Found {{ .Release.Name }}-composio-api-key (COMPOSIO_API_KEY)."

        - secret:
            checkName: "Encryption key secret present"
            secretName: "{{ .Release.Name }}-encryption-key"
            namespace: "{{ .Release.Namespace }}"
            key: "ENCRYPTION_KEY"
            outcomes:
              - fail:
                  message: "Missing {{ .Release.Name }}-encryption-key or key ENCRYPTION_KEY."
              - pass:
                  message: "Found {{ .Release.Name }}-encryption-key (ENCRYPTION_KEY)."

        - secret:
            checkName: "JWT secret present"
            secretName: "{{ .Release.Name }}-jwt-secret"
            namespace: "{{ .Release.Namespace }}"
            key: "JWT_SECRET"
            outcomes:
              - fail:
                  message: "Missing {{ .Release.Name }}-jwt-secret or key JWT_SECRET."
              - pass:
                  message: "Found {{ .Release.Name }}-jwt-secret (JWT_SECRET)."

        - secret:
            checkName: "Temporal encryption key secret present"
            secretName: "{{ .Release.Name }}-temporal-encryption-key"
            namespace: "{{ .Release.Namespace }}"
            key: "TEMPORAL_TRIGGER_ENCRYPTION_KEY"
            outcomes:
              - fail:
                  message: "Missing {{ .Release.Name }}-temporal-encryption-key or key TEMPORAL_TRIGGER_ENCRYPTION_KEY."
              - pass:
                  message: "Found {{ .Release.Name }}-temporal-encryption-key (TEMPORAL_TRIGGER_ENCRYPTION_KEY)."

        # --- Composio API key validity ---
        - textAnalyze:
            checkName: "Composio API key is valid"
            fileName: "/validate-composio-api-key.log"
            regexGroups: 'RESULT=(?P<Result>[A-Z_]+) HTTP_CODE=(?P<Code>\d+)'
            outcomes:
              - pass:
                  when: "Code == 200"
                  message: "Composio API key validated (HTTP {{ .Code }})."
              - fail:
                  when: "Code == 401 || Code == 403"
                  message: "Composio API key rejected (HTTP {{ .Code }})."
              - warn:
                  message: "Could not confirm Composio key (RESULT={{ .Result }}, HTTP={{ .Code }}). Check egress/DNS/firewall."

        {{- if .Values.openAI.enabled }}
        - secret:
            checkName: "OpenAI source secret present"
            secretName: "{{ .Values.openAI.secretRef }}"
            namespace: "{{ .Release.Namespace }}"
            key: "{{ .Values.openAI.key }}"
            outcomes:
              - fail:
                  message: "Missing OpenAI source Secret {{ .Values.openAI.secretRef }} or key {{ .Values.openAI.key }}."
              - pass:
                  message: "Found OpenAI source Secret {{ .Values.openAI.secretRef }} (key {{ .Values.openAI.key }})."

        - textAnalyze:
            checkName: "OpenAI API key is valid"
            fileName: "/validate-openai-api-key.log"
            regexGroups: 'RESULT=(?P<Result>[A-Z_]+) HTTP_CODE=(?P<Code>\d+)'
            outcomes:
              - pass:
                  when: "Code == 200"
                  message: "OpenAI API key validated (HTTP {{ .Code }})."
              - fail:
                  when: "Code == 401 || Code == 403"
                  message: "OpenAI API key rejected (HTTP {{ .Code }})."
              - warn:
                  message: "Could not confirm OpenAI key (RESULT={{ .Result }}, HTTP={{ .Code }}). Check egress/DNS/firewall."
        {{- end }}

        {{- if eq .Values.apollo.objectStorage.backend "s3" }}
        - secret:
            checkName: "S3 access key secret present"
            secretName: "{{ .Values.apollo.objectStorage.accessKey.secretName }}"
            namespace: "{{ .Release.Namespace }}"
            key: "{{ .Values.apollo.objectStorage.accessKey.key }}"
            outcomes:
              - fail:
                  message: "Missing S3 accessKey Secret {{ .Values.apollo.objectStorage.accessKey.secretName }} or key {{ .Values.apollo.objectStorage.accessKey.key }}."
              - pass:
                  message: "Found S3 accessKey Secret."

        - secret:
            checkName: "S3 secret key secret present"
            secretName: "{{ .Values.apollo.objectStorage.secretKey.secretName }}"
            namespace: "{{ .Release.Namespace }}"
            key: "{{ .Values.apollo.objectStorage.secretKey.key }}"
            outcomes:
              - fail:
                  message: "Missing S3 secretKey Secret {{ .Values.apollo.objectStorage.secretKey.secretName }} or key {{ .Values.apollo.objectStorage.secretKey.key }}."
              - pass:
                  message: "Found S3 secretKey Secret."
        {{- end }}

        {{- if eq .Values.apollo.objectStorage.backend "azure_blob_storage" }}
        - secret:
            checkName: "Azure connection string secret present"
            secretName: "{{ .Values.apollo.objectStorage.azureConnectionString.secretName }}"
            namespace: "{{ .Release.Namespace }}"
            key: "{{ .Values.apollo.objectStorage.azureConnectionString.key }}"
            outcomes:
              - fail:
                  message: "Missing Azure Secret {{ .Values.apollo.objectStorage.azureConnectionString.secretName }} or key {{ .Values.apollo.objectStorage.azureConnectionString.key }}."
              - pass:
                  message: "Found Azure connection string Secret."
        {{- end }}

        {{- if .Values.smtp.connectionString }}
        - secret:
            checkName: "SMTP password source secret present"
            secretName: "{{ .Values.smtp.password.secretRef }}"
            namespace: "{{ .Release.Namespace }}"
            key: "{{ .Values.smtp.password.key }}"
            outcomes:
              - fail:
                  message: "Missing SMTP password Secret {{ .Values.smtp.password.secretRef }} or key {{ .Values.smtp.password.key }}."
              - pass:
                  message: "Found SMTP password Secret."

        - textAnalyze:
            checkName: "SMTP host reachable (TCP)"
            fileName: "/check-smtp-tcp.log"
            regexGroups: 'RESULT=(?P<Result>[A-Z_]+)'
            outcomes:
              - pass:
                  when: 'Result == "OK"'
                  message: "SMTP {{ .Values.smtp.host }}:{{ .Values.smtp.port }} is reachable."
              - fail:
                  message: "Cannot reach SMTP {{ .Values.smtp.host }}:{{ .Values.smtp.port }} from the cluster."
        {{- end }}

        - secret:
            checkName: "Apollo Postgres password source secret present"
            secretName: "{{ .Values.database.apollo.password.secretRef }}"
            namespace: "{{ .Release.Namespace }}"
            key: "{{ .Values.database.apollo.password.key }}"
            outcomes:
              - fail:
                  message: "Missing Apollo Postgres password Secret {{ .Values.database.apollo.password.secretRef }} or key {{ .Values.database.apollo.password.key }}."
              - pass:
                  message: "Found Apollo Postgres password Secret."

        - textAnalyze:
            checkName: "Apollo Postgres connectivity"
            fileName: "/validate-postgres-apollo.log"
            regexGroups: 'RESULT=(?P<Result>[A-Z_]+)'
            outcomes:
              - pass:
                  when: 'Result == "OK"'
                  message: "Can connect to Apollo Postgres and run a query."
              - fail:
                  when: 'Result == "ERROR"'
                  message: "Cannot connect to Apollo Postgres (check host/port/sslmode/network/creds)."
              - warn:
                  message: "Apollo Postgres password missing (Secret not readable or key missing)."

        - secret:
            checkName: "Thermos Postgres password source secret present"
            secretName: "{{ .Values.database.thermos.password.secretRef }}"
            namespace: "{{ .Release.Namespace }}"
            key: "{{ .Values.database.thermos.password.key }}"
            outcomes:
              - fail:
                  message: "Missing Thermos Postgres password Secret {{ .Values.database.thermos.password.secretRef }} or key {{ .Values.database.thermos.password.key }}."
              - pass:
                  message: "Found Thermos Postgres password Secret."

        - textAnalyze:
            checkName: "Thermos Postgres connectivity"
            fileName: "/validate-postgres-thermos.log"
            regexGroups: 'RESULT=(?P<Result>[A-Z_]+)'
            outcomes:
              - pass:
                  when: 'Result == "OK"'
                  message: "Can connect to Thermos Postgres and run a query."
              - fail:
                  when: 'Result == "ERROR"'
                  message: "Cannot connect to Thermos Postgres (check host/port/sslmode/network/creds)."
              - warn:
                  message: "Thermos Postgres password missing (Secret not readable or key missing)."

        {{- if .Values.externalRedis }}
        - secret:
            checkName: "Redis password secret present (if used)"
            secretName: "{{ .Values.redisConnection.password.secretRef }}"
            namespace: "{{ .Release.Namespace }}"
            key: "{{ .Values.redisConnection.password.key }}"
            outcomes:
              - warn:
                  message: "Redis password Secret/key not found (OK if Redis is unauthenticated)."
              - pass:
                  message: "Found Redis password Secret/key."

        - textAnalyze:
            checkName: "Redis connectivity"
            fileName: "/validate-redis.log"
            regexGroups: 'RESULT=(?P<Result>[A-Z_]+)'
            outcomes:
              - pass:
                  when: 'Result == "OK"'
                  message: "Can connect to Redis and PING."
              - fail:
                  message: "Cannot connect to Redis (check host/port/network/password)."
        {{- end }}
